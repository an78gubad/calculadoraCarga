<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Carga - Transporte Argentino</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-image: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)),
                            url('https://img.freepik.com/free-vector/highway-road-desert-landscape-evening_107791-10161.jpg');
            background-size: cover;
            background-attachment: fixed;
        }

        .container {
            margin-top: 30px;
        }

        .card {
            border: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 3px solid #ffc107;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .main-title {
            color: #2c3e50;
            font-weight: 700;
            position: relative;
            display: inline-block;
        }

        .main-title i {
            color: #ffc107;
            margin-right: 10px;
            font-size: 2rem;
        }

        .result-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #28a745;
        }

        .btn-primary {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }

        .btn-primary:hover {
            background-color: #34495e;
            border-color: #34495e;
        }

        .btn-secondary {
            background-color: #95a5a6;
            border-color: #95a5a6;
        }

        .eje-select {
            border: 2px solid #e9ecef;
        }

        .alert-success {
            background-color: #2ecc71;
            color: white;
            border: none;
        }

        .road-divider {
            height: 3px;
            background: repeating-linear-gradient(
                90deg,
                #fff,
                #fff 10px,
                #000 10px,
                #000 20px
            );
            margin: 20px 0;
        }

        .form-label {
            color: #2c3e50;
            font-weight: 600;
        }

        .input-group-text {
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }

        .eliminar-eje {
            border-color: #e74c3c !important;
            color: #e74c3c !important;
        }

        .eliminar-eje:hover {
            background-color: #e74c3c !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="card shadow">
            <div class="card-header text-center">
                <h1 class="main-title mb-0">
                    <i class="fas fa-truck"></i>
                    Calculadora de Carga para Transportes
                </h1>
            </div>
            <div class="card-body">
                <form id="calculadoraForm">
                    <div class="mb-3">
                        <label for="potenciaCV" class="form-label">Potencia del Vehículo (CV)</label>
                        <input type="number" class="form-control" id="potenciaCV" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Configuración de Ejes y Grupos</label>
                        <div class="grupos-container">
                            <div class="grupo-ejes card p-3 mb-3">
                                <div class="mb-2">
                                    <select class="form-select grupo-tipo">
                                        <option value="">Seleccione tipo de grupo</option>
                                        <option value="simple">Eje Simple</option>
                                        <option value="tandem">Tándem (2 ejes)</option>
                                        <option value="tridem">Trídem (3 ejes)</option>
                                        <option value="mixto">Mixto (Tándem + Simple)</option>
                                    </select>
                                </div>
                                
                                <div class="configuracion-grupo">
                                    <!-- Los campos se cargarán dinámicamente según el tipo seleccionado -->
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="agregarGrupo">
                            <i class="fas fa-plus"></i> Agregar grupo de ejes
                        </button>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Calcular</button>
                    </div>
                </form>

                <div class="result-box d-none" id="resultados">
                    <h4 class="text-center mb-3">Resultados</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Peso máximo por ejes:</strong> <span id="pesoEjes">0</span> toneladas</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Peso máximo por potencia:</strong> <span id="pesoPotencia">0</span> toneladas</p>
                        </div>
                    </div>
                    <div class="alert alert-success text-center mb-3">
                        <strong>Peso máximo permitido:</strong> <span id="pesoMaximo">0</span> toneladas
                    </div>
                    
                    <div class="explanation-box border-top pt-3">
                        <h5><i class="fas fa-info-circle text-primary"></i> Explicación del cálculo:</h5>
                        <div id="explicacionCalculo" class="mt-3">
                            <ol class="explanation-list">
                                <li class="mb-2">
                                    <strong>Cálculo por ejes:</strong>
                                    <div id="explicacionEjes" class="text-muted ps-3"></div>
                                </li>
                                <li class="mb-2">
                                    <strong>Cálculo por potencia:</strong>
                                    <div id="explicacionPotencia" class="text-muted ps-3"></div>
                                </li>
                                <li class="mb-2">
                                    <strong>Determinación del peso final:</strong>
                                    <div id="explicacionFinal" class="text-muted ps-3"></div>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-3 text-muted">
            <small><i class="fas fa-road"></i> Según normativa argentina vigente</small>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const TEMPLATES = {
            simple: `
                <div class="mb-2">
                    <label class="form-label">Tipo de Rodado</label>
                    <select class="form-select subtype-select">
                        <option value="ruedas_individuales">Ruedas Individuales (6.000 kg)</option>
                        <option value="rodado_doble">Rodado Doble (10.500 kg)</option>
                    </select>
                </div>
            `,
            tandem: `
                <div class="mb-2">
                    <label class="form-label">Tipo de Rodado</label>
                    <select class="form-select subtype-select">
                        <option value="ruedas_individuales">Ruedas Individuales (10.000 kg)</option>
                        <option value="mixto">Mixto (14.000 kg)</option>
                        <option value="rodado_doble">Rodado Doble (18.000 kg)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Distancia entre ejes (metros)</label>
                    <input type="number" step="0.01" class="form-control distancia-input" required>
                </div>
            `,
            tridem: `
                <div class="mb-2">
                    <label class="form-label">Tipo de Rodado</label>
                    <select class="form-select subtype-select">
                        <option value="rodado_doble">Rodado Doble (25.500 kg)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Distancia entre 1º y 2º eje (metros)</label>
                    <input type="number" step="0.01" class="form-control distancia1-input" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Distancia entre 2º y 3º eje (metros)</label>
                    <input type="number" step="0.01" class="form-control distancia2-input" required>
                </div>
            `,
            mixto: `
                <div class="tandem-section mb-3">
                    <h6>Configuración del Tándem</h6>
                    <div class="mb-2">
                        <label class="form-label">Tipo de Rodado</label>
                        <select class="form-select tandem-subtype-select">
                            <option value="ruedas_individuales">Ruedas Individuales</option>
                            <option value="mixto">Mixto</option>
                            <option value="rodado_doble">Rodado Doble</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Distancia entre ejes del tándem (metros)</label>
                        <input type="number" step="0.01" class="form-control tandem-distancia-input" required>
                    </div>
                </div>
                <div class="simple-section mb-3">
                    <h6>Configuración del Eje Simple</h6>
                    <div class="mb-2">
                        <label class="form-label">Tipo de Rodado</label>
                        <select class="form-select simple-subtype-select">
                            <option value="ruedas_individuales">Ruedas Individuales</option>
                            <option value="rodado_doble">Rodado Doble</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">Distancia entre tándem y eje simple (metros)</label>
                    <input type="number" step="0.01" class="form-control distancia-entre-input" required>
                </div>
            `
        };

        const limitesPeso = {
            'eje_simple_ruedas_individuales': 6000,
            'eje_simple_rodado_doble': 10500,
            'tandem_ruedas_individuales': 10000,
            'tandem_mixto': 14000,
            'tandem_rodado_doble': 18000,
            'tridem_rodado_doble': 25500
        };

        const PESO_MAXIMO_ABSOLUTO = 75; // toneladas

        $(document).ready(function() {
            $('#agregarGrupo').click(function() {
                const nuevoGrupo = $(`
                    <div class="grupo-ejes card p-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <select class="form-select grupo-tipo" style="width: auto;">
                                <option value="">Seleccione tipo de grupo</option>
                                <option value="simple">Eje Simple</option>
                                <option value="tandem">Tándem (2 ejes)</option>
                                <option value="tridem">Trídem (3 ejes)</option>
                                <option value="mixto">Mixto (Tándem + Simple)</option>
                            </select>
                            <button class="btn btn-outline-danger btn-sm eliminar-grupo">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="configuracion-grupo"></div>
                    </div>
                `);
                $('.grupos-container').append(nuevoGrupo);
            });

            $(document).on('change', '.grupo-tipo', function() {
                const tipo = $(this).val();
                const configContainer = $(this).closest('.grupo-ejes').find('.configuracion-grupo');
                if (tipo && TEMPLATES[tipo]) {
                    configContainer.html(TEMPLATES[tipo]);
                } else {
                    configContainer.empty();
                }
            });

            $(document).on('click', '.eliminar-grupo', function() {
                $(this).closest('.grupo-ejes').remove();
            });

            // Función para verificar si un grupo está completo
            function grupoEstaCompleto($grupo) {
                const tipo = $grupo.find('.grupo-tipo').val();
                if (!tipo) return false;

                switch(tipo) {
                    case 'simple':
                        return $grupo.find('.subtype-select').val() !== null;
                    case 'tandem':
                        return $grupo.find('.subtype-select').val() !== null && 
                               $grupo.find('.distancia-input').val() !== '';
                    case 'tridem':
                        return $grupo.find('.subtype-select').val() !== null && 
                               $grupo.find('.distancia1-input').val() !== '' &&
                               $grupo.find('.distancia2-input').val() !== '';
                    case 'mixto':
                        return $grupo.find('.tandem-subtype-select').val() !== null &&
                               $grupo.find('.tandem-distancia-input').val() !== '' &&
                               $grupo.find('.simple-subtype-select').val() !== null &&
                               $grupo.find('.distancia-entre-input').val() !== '';
                    default:
                        return false;
                }
            }

            // Función para actualizar cálculos
            function actualizarCalculos() {
                const potenciaCV = parseFloat($('#potenciaCV').val());
                if (!potenciaCV) return;

                const configuracionGrupos = [];
                let todosGruposCompletos = true;

                $('.grupo-ejes').each(function() {
                    if (!grupoEstaCompleto($(this))) {
                        todosGruposCompletos = false;
                        return false; // break the loop
                    }

                    const tipo = $(this).find('.grupo-tipo').val();
                    let grupo = {
                        groupType: tipo
                    };

                    switch(tipo) {
                        case 'simple':
                            grupo.subtype = $(this).find('.subtype-select').val();
                            break;
                        case 'tandem':
                            grupo.subtype = $(this).find('.subtype-select').val();
                            grupo.distancia = parseFloat($(this).find('.distancia-input').val());
                            break;
                        case 'tridem':
                            grupo.subtype = $(this).find('.subtype-select').val();
                            grupo.distancias = [
                                parseFloat($(this).find('.distancia1-input').val()),
                                parseFloat($(this).find('.distancia2-input').val())
                            ];
                            break;
                        case 'mixto':
                            grupo.tandem = {
                                subtype: $(this).find('.tandem-subtype-select').val(),
                                distancia: parseFloat($(this).find('.tandem-distancia-input').val())
                            };
                            grupo.independiente = {
                                subtype: $(this).find('.simple-subtype-select').val()
                            };
                            grupo.distanciaEntre = parseFloat($(this).find('.distancia-entre-input').val());
                            break;
                    }
                    
                    configuracionGrupos.push(grupo);
                });

                if (!todosGruposCompletos || configuracionGrupos.length === 0) {
                    $('#resultados').addClass('d-none');
                    return;
                }

                const resultado = calcularPesoMaximo(potenciaCV, configuracionGrupos);
                
                $('#pesoEjes').text((resultado.pesoMaximoEjes / 1000).toFixed(2));
                $('#pesoPotencia').text(resultado.pesoMaximoPotencia.toFixed(2));
                $('#pesoMaximo').text(resultado.pesoMaximoPermitido.toFixed(2));

                // Generar explicaciones
                let explicacionEjes = 'Suma de los pesos máximos permitidos por eje:<br>';
                configuracionGrupos.forEach((grupo, index) => {
                    const pesoGrupo = calcularPesoGrupo(grupo);
                    const nombreGrupo = $(".grupo-tipo option[value='" + grupo.groupType + "']").text().split('(')[0];
                    explicacionEjes += `→ Grupo ${index + 1} (${nombreGrupo}): ${pesoGrupo} toneladas<br>`;
                });
                explicacionEjes += `<strong>Total por ejes: ${(resultado.pesoMaximoEjes / 1000).toFixed(2)} toneladas</strong>`;
                
                const explicacionPotencia = `Según la normativa, se requiere una relación peso-potencia mínima de 4.25 CV/t.<br>
                    Con una potencia de ${potenciaCV} CV:<br>
                    ${potenciaCV} CV ÷ 4.25 CV/t = ${resultado.pesoMaximoPotencia.toFixed(2)} toneladas máximas por potencia`;

                const explicacionFinal = `Se toma el menor valor entre:<br>
                    → Peso máximo por ejes: ${(resultado.pesoMaximoEjes / 1000).toFixed(2)} toneladas<br>
                    → Peso máximo por potencia: ${resultado.pesoMaximoPotencia.toFixed(2)} toneladas<br>
                    → Peso máximo absoluto: ${(resultado.pesoMaximoAbsoluto / 1000).toFixed(2)} toneladas<br>
                    <strong>Por lo tanto, el peso máximo permitido es ${resultado.pesoMaximoPermitido.toFixed(2)} toneladas</strong>`;

                $('#explicacionEjes').html(explicacionEjes);
                $('#explicacionPotencia').html(explicacionPotencia);
                $('#explicacionFinal').html(explicacionFinal);
                
                $('#resultados').removeClass('d-none');
            }

            // Eventos para actualización automática
            $(document).on('change input', '#potenciaCV, .subtype-select, .grupo-tipo, .tandem-subtype-select, .simple-subtype-select', actualizarCalculos);
            $(document).on('input', '.distancia-input, .distancia1-input, .distancia2-input, .tandem-distancia-input, .distancia-entre-input', actualizarCalculos);

            // Remover el evento submit del formulario ya que no lo necesitamos más
            $('#calculadoraForm').submit(function(e) {
                e.preventDefault();
            });

            // Opcional: Remover el botón de calcular ya que no es necesario
            $('#calculadoraForm button[type="submit"]').remove();
        });

        // Función para calcular reducción por distancia insuficiente (< 1.20m)
        // Por cada 0.08m (8 cm) por debajo de 1.20, se reduce 1000 kg (1 TN)
        function calcularReduccion(distancia) {
            if (distancia >= 1.20) return 0;
            const diferencia = 1.20 - distancia;
            const reduccionTonKg = Math.floor((diferencia * 100) / 8) * 1000;
            return reduccionTonKg;
        }

        function calcularPesoGrupo(grupo) {
            let pesoGrupo = 0;

            switch(grupo.groupType) {
                case 'simple':
                    pesoGrupo = limitesPeso['eje_' + grupo.groupType + '_' + grupo.subtype];
                    break;
                case 'tandem':
                    if (grupo.distancia >= 1.20 && grupo.distancia <= 2.40) {
                        pesoGrupo = limitesPeso[grupo.groupType + '_' + grupo.subtype];
                    } else if (grupo.distancia < 1.20) {
                        const reduccion = calcularReduccion(grupo.distancia);
                        const base = limitesPeso[grupo.groupType + '_' + grupo.subtype];
                        pesoGrupo = Math.max(base - reduccion, 0);
                    } else if (grupo.distancia > 2.40) {
                        // Si la distancia es mayor a 2.40, se tratan como ejes independientes
                        if (grupo.subtype === 'rodado_doble') {
                            pesoGrupo = 2 * limitesPeso['eje_simple_rodado_doble'];
                        } else {
                            pesoGrupo = 2 * limitesPeso['eje_simple_ruedas_individuales'];
                        }
                    }
                    break;
                case 'tridem':
                    if (grupo.distancias) {
                        const d1 = grupo.distancias[0];
                        const d2 = grupo.distancias[1];
                        let reduccion = 0;
                        if (d1 < 1.20) reduccion += calcularReduccion(d1);
                        if (d2 < 1.20) reduccion += calcularReduccion(d2);
                        
                        if (d1 >= 1.20 && d1 <= 2.40 && d2 >= 1.20 && d2 <= 2.40) {
                            pesoGrupo = limitesPeso[grupo.groupType + '_' + grupo.subtype];
                        } else {
                            const base = limitesPeso[grupo.groupType + '_' + grupo.subtype];
                            pesoGrupo = Math.max(base - reduccion, 0);
                        }
                    }
                    break;
                case 'mixto':
                    // Calcular peso del tándem
                    let pesoTandem = 0;
                    if (grupo.tandem.distancia >= 1.20 && grupo.tandem.distancia <= 2.40) {
                        pesoTandem = limitesPeso['tandem_' + grupo.tandem.subtype];
                    } else if (grupo.tandem.distancia < 1.20) {
                        const reduccion = calcularReduccion(grupo.tandem.distancia);
                        const base = limitesPeso['tandem_' + grupo.tandem.subtype];
                        pesoTandem = Math.max(base - reduccion, 0);
                    } else if (grupo.tandem.distancia > 2.40) {
                        if (grupo.tandem.subtype === 'rodado_doble') {
                            pesoTandem = 2 * limitesPeso['eje_simple_rodado_doble'];
                        } else {
                            pesoTandem = 2 * limitesPeso['eje_simple_ruedas_individuales'];
                        }
                    }
                    
                    // Calcular peso del eje independiente
                    const pesoIndependiente = limitesPeso['eje_simple_' + grupo.independiente.subtype];
                    
                    pesoGrupo = pesoTandem + pesoIndependiente;
                    break;
            }

            return pesoGrupo / 1000; // Convertir a toneladas
        }

        function calcularPesoMaximo(potenciaCV, configuracionGrupos) {
            let pesoMaximoEjes = 0;

            configuracionGrupos.forEach(grupo => {
                pesoMaximoEjes += calcularPesoGrupo(grupo);
            });

            const pesoMaximoPotencia = potenciaCV / 4.25;
            const pesoMaximoPermitido = Math.min(
                pesoMaximoEjes, 
                pesoMaximoPotencia,
                PESO_MAXIMO_ABSOLUTO
            );

            return {
                pesoMaximoEjes: pesoMaximoEjes * 1000,
                pesoMaximoPotencia: pesoMaximoPotencia,
                pesoMaximoPermitido: pesoMaximoPermitido,
                pesoMaximoAbsoluto: PESO_MAXIMO_ABSOLUTO * 1000
            };
        }
    </script>
</body>
</html>
